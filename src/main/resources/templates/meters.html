<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/css/home.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <title>Meters</title>
</head>
<body>
    <input type="hidden" id="pricePerKwh" th:value="${meterFormula != null ? meterFormula.pricePerKwh : 0.2}">
    <input type="hidden" id="divider" th:value="${meterFormula != null ? meterFormula.divider : 2}">

    <div th:replace="~{fragments/sidebar :: sidebar(currentPage=${currentPage})}"></div>

    <div th:replace="~{fragments/sidebar :: sidebar(floorNumber=${floorNumber})}"></div>

    <div class="main-content">
        <header>
            <h1 th:text="#{meters.title} + ' ' + ${floorNumber}">Floor 1</h1>
            <p th:text="#{meters.description}">Manage Air Conditioners' Meters and Readings</p>
        </header>

        <p th:if="${meterFormula == null}" class="error-message" th:text="#{meters.microservice.failure.message}">
            ⚠️ Meter Formula Service unavailable. Total cost calculation won't work correctly.
        </p>

        <section class="add-company">
            <h2 th:text="#{meters.addMeter.title}">Add Meter</h2>
            <p th:if="${errorMessage}" th:text="${errorMessage}" class="error-message"></p>
            <form id="addMeterForm" class="styled-form" th:action="@{'/meters/floor/' + ${floorNumber}}"
                  th:method="POST" th:object="${meterRequest}">
                <input th:field="*{meterName}" type="text" name="meterName" th:placeholder="#{meters.addMeter.name.placeholder}" required>
                <input th:field="*{outsideBody}" type="text" th:placeholder="#{meters.addMeter.outsideBody.placeholder}" required>
                <input th:field="*{room}" type="text" th:placeholder="#{meters.addMeter.room.placeholder}" required>
                <input th:field="*{description}" type="text" th:placeholder="#{meters.addMeter.description.placeholder}">
                <button type="submit"><i class="fa-solid fa-plus"></i>
                    <span th:text="#{meters.add.button}"> Add</span>
                </button>
            </form>
        </section>

        <section class="recent">
            <h2 th:text="#{section.readings.title}">Readings</h2>

            <form th:action="@{'/meters/save?floorNumber=' + ${floorNumber}}" th:method="POST" th:object="${readingWrapper}" >
                <table class="styled-table">
                    <thead>
                    <tr>
                        <th th:text="#{meters.table.th.meterName}">Meter</th>
                        <th th:text="#{meters.table.th.outsideBody}">Out Body</th>
                        <th th:text="#{meters.table.th.room}">Room</th>
                        <th th:text="#{meters.table.th.description}">Description</th>
                        <th th:text="#{meters.table.th.energyPercentage}">% Energy</th>
                        <th th:text="#{meters.table.th.oldReading}">Old kWh</th>
                        <th th:text="#{meters.table.th.newReading}">New kWh</th>
                        <th th:text="#{meters.table.th.diffReading}">Diff kWh</th>
                        <th th:text="#{meters.table.th.totalCost}">Total Cost</th>
                    </tr>
                    </thead>
                    <tbody id="readingsBody">
                    <tr th:each="meter, iter : ${readingWrapper.readings}">
                        <td>
                            <span th:text="${meters[iter.index].meterName}"></span>
                            <input type="hidden" th:field="*{readings[__${iter.index}__].meterName}"/>
                        </td>
                        <td><input th:field="*{readings[__${iter.index}__].outsideBody}" type="text" /></td>
                        <td><input th:field="*{readings[__${iter.index}__].room}" type="text" /></td>
                        <td><input th:field="*{readings[__${iter.index}__].description}" type="text" /></td>
                        <td><input th:field="*{readings[__${iter.index}__].energyPercentage}" class="energy-percentage" type="number" /></td>
                        <td><input th:field="*{readings[__${iter.index}__].oldReadings}" class="old" type="number" /></td>
                        <td><input th:field="*{readings[__${iter.index}__].newReadings}" class="new" type="number" /></td>
                        <td><input th:field="*{readings[__${iter.index}__].differenceReadings}" class="diff" type="number" readonly /></td>
                        <td><input th:field="*{readings[__${iter.index}__].totalCost}" class="total-cost" type="number" readonly /></td>
                    </tr>
                    </tbody>
                </table>
                <div class="save-container">
                    <button th:unless="${meters.isEmpty()}" type="submit" class="save-btn"><i class="fas fa-save"></i>
                       <span th:text="#{save.button}"> Save readings</span>
                    </button>
                </div>
            </form>

            <form class="swap-form" th:action="@{'/meters/swap?floorNumber=' + ${floorNumber}}" th:method="POST">
                <button th:unless="${meters.isEmpty()}" th:disabled="${areSwapped == true}" type="submit" class="swap-btn"><i class="fas fa-exchange-alt"></i>
                   <span th:text="#{swap.button}"> Swap readings</span>
                </button>
            </form>
        </section>
    </div>

    <script src="/js/sidebar/sidebar.js"></script>
    <script src="/js/readings/meter-calculator.js"></script>
</body>

</html>